<!DOCTYPE html>
<html lang="zh-cn">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>实验中学自习安静情况检测程序</title>
    <link rel="icon" href="https://bigjackson.top/images/avatar.jpg" type="image/x-icon">
	<style>
		body { margin: 0; overflow: hidden; background: #222; }
		canvas { display: block; }
	</style>
</head>
<body>
	<div id="micAuth" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(34,34,34,0.95);z-index:10;display:flex;flex-direction:column;align-items:center;justify-content:center;">
		<h2 style="color:#fff;">需要麦克风权限</h2>
		<p style="color:#ccc;">请点击下方按钮并允许浏览器访问麦克风</p>
		<button id="authBtn" style="font-size:1.2em;padding:0.5em 2em;border-radius:8px;border:none;background:#4caf50;color:#fff;cursor:pointer;">授权麦克风</button>
	</div>
	<div id="sidePanel" style="position:fixed;top:0;right:0;width:300px;height:100vh;background:rgba(30,30,30,0.95);z-index:5;color:#fff;padding:24px 18px;box-shadow:-2px 0 8px #0003;display:flex;flex-direction:column;gap:18px;font-family:sans-serif;">
		<div style="display:flex;align-items:center;justify-content:space-between;">
			<h3 style="margin:0;">参数面板</h3>
			<button id="settingBtn" style="padding:4px 16px;border-radius:6px;border:none;background:#4caf50;color:#fff;cursor:pointer;font-size:1em;">设置</button>
		</div>
		<div>选择麦克风：<select id="micSelect" style="width:180px;"></select></div>
		<div>当前分贝：<span id="volVal">0</span> dB</div>
		<div>球数量：<span id="ballCount">0</span></div>
		<div style="margin-top:10px;">球最大数量：<span id="maxBallVal">20</span></div>
		<input type="range" id="maxBall" min="1" max="30" value="20" style="width:100%;">
		<div style="margin-top:10px;">灵敏度（阈值）：<span id="sensVal">0.05</span></div>
		<input type="range" id="sens" min="0.01" max="0.2" step="0.01" value="0.05" style="width:100%;">
	<div style="margin-top:10px;">球消失延迟（毫秒）：<span id="delayVal">5000</span></div>
	<input type="range" id="delay" min="5000" max="10000" step="100" value="5000" style="width:100%;">
	</div>
		<canvas id="ballCanvas"></canvas>
		<div style="position:fixed;bottom:10px;right:20px;color:#bbb;font-size:15px;z-index:20;pointer-events:none;user-select:none;">作者：高一七班 BigJackson</div>
		<div id="settingModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(34,34,34,0.7);z-index:100;align-items:center;justify-content:center;">
			<div style="background:#222;padding:32px 40px;border-radius:16px;box-shadow:0 4px 24px #0006;min-width:320px;display:flex;flex-direction:column;align-items:center;">
				<h2 id="modalTitle" style="color:#fff;margin-bottom:10px;">设置</h2>
				<div style="color:#bbb;font-size:16px;margin-bottom:18px;">作者：高一七班 BigJackson</div>
                <p style="color:#ccc;font-size:15px;margin-bottom:18px;text-align:center;">
                    本程序用于检测教室自习时的安静情况，通过麦克风实时分析环境声音分贝，<br>并以彩球动画形式进行可视化展示。参数可在右侧面板调整，支持多麦克风选择。
                </p>
				<button id="micPermBtn" style="font-size:1.1em;padding:0.5em 2em;border-radius:8px;border:none;background:#4caf50;color:#fff;cursor:pointer;margin-bottom:10px;">麦克风权限申请</button>
				<button id="closeSetting" style="font-size:1em;padding:0.3em 1.5em;border-radius:8px;border:none;background:#555;color:#fff;cursor:pointer;">关闭</button>
			</div>
		</div>
	<script>
		const canvas = document.getElementById('ballCanvas');
		const ctx = canvas.getContext('2d');
		let balls = [];
		let lastSoundTime = Date.now();

		// 参数面板相关变量
	let maxBall = 20;
		let sens = 0.05;
	let delay = 5000;
	let currentVolume = 0;
	let currentDb = 0;

		// 右侧面板元素
		const volVal = document.getElementById('volVal');
		const ballCount = document.getElementById('ballCount');
		const maxBallInput = document.getElementById('maxBall');
		const maxBallVal = document.getElementById('maxBallVal');
		const sensInput = document.getElementById('sens');
		const sensVal = document.getElementById('sensVal');
		const delayInput = document.getElementById('delay');
		const delayVal = document.getElementById('delayVal');
		const micSelect = document.getElementById('micSelect');

		maxBallInput.oninput = function() {
			maxBall = parseInt(this.value);
			maxBallVal.textContent = maxBall;
		};
		sensInput.oninput = function() {
			sens = parseFloat(this.value);
			sensVal.textContent = sens;
		};
		delayInput.oninput = function() {
			delay = parseInt(this.value);
			delayVal.textContent = delay;
		};

		// 麦克风设备列表和切换
		let audioStream = null;
		let audioCtx = null;
		let analyser = null;
		let mic = null;
		let dataArray = null;
		let detectTimer = null;

		function stopAudio() {
			if (audioStream) {
				audioStream.getTracks().forEach(track => track.stop());
				audioStream = null;
			}
			if (audioCtx) {
				audioCtx.close();
				audioCtx = null;
			}
			if (detectTimer) {
				clearTimeout(detectTimer);
				detectTimer = null;
			}
		}

		function startAudio(deviceId) {
			stopAudio();
			navigator.mediaDevices.getUserMedia({ audio: { deviceId: deviceId ? { exact: deviceId } : undefined } }).then(stream => {
				audioStream = stream;
				audioCtx = new (window.AudioContext || window.webkitAudioContext)();
				analyser = audioCtx.createAnalyser();
				mic = audioCtx.createMediaStreamSource(stream);
				analyser.fftSize = 512;
				mic.connect(analyser);
				dataArray = new Uint8Array(analyser.fftSize);

				function detectVolume() {
					analyser.getByteTimeDomainData(dataArray);
					let sum = 0;
					for (let i = 0; i < dataArray.length; i++) {
						let v = (dataArray[i] - 128) / 128;
						sum += v*v;
					}
					const volume = Math.sqrt(sum / dataArray.length);
					currentVolume = volume;
					if (volume > sens) {
						lastSoundTime = Date.now();
						addBalls(volume);
					}
					detectTimer = setTimeout(detectVolume, 80);
				}
				detectVolume();
			}).catch(err => {
				alert('无法访问麦克风: ' + err);
			});
		}

		function updateMicList() {
			navigator.mediaDevices.enumerateDevices().then(devices => {
				const mics = devices.filter(d => d.kind === 'audioinput');
				micSelect.innerHTML = '';
				mics.forEach((micDev, idx) => {
					const option = document.createElement('option');
					option.value = micDev.deviceId;
					option.textContent = micDev.label || `麦克风${idx+1}`;
					micSelect.appendChild(option);
				});
			});
		}

		micSelect.onchange = function() {
			startAudio(this.value);
		};

		function resizeCanvas() {
			canvas.width = window.innerWidth;
			canvas.height = window.innerHeight;
		}
		window.addEventListener('resize', resizeCanvas);
		resizeCanvas();

		function randomColor() {
			return `hsl(${Math.random()*360}, 80%, 60%)`;
		}

		let justRecovered = false;
		function addBalls(volume) {
			// 如果所有球都在消失，且有新声音，则清空球数组，保证新球正常显示
			if (balls.length > 0 && balls.every(ball => ball.fading)) {
				balls = [];
				justRecovered = true;
			}
			const maxRadius = 80;
			const count = Math.min(maxBall, Math.floor(volume * 20));
			for (let i = 0; i < count; i++) {
				balls.push({
					x: Math.random() * canvas.width,
					y: Math.random() * canvas.height,
					r: maxRadius,
					color: randomColor(),
					vx: (Math.random()-0.5)*2,
					vy: (Math.random()-0.5)*2,
					alpha: 0.8,
					fading: false
				});
			}
		}

		function drawBalls() {
			ctx.clearRect(0, 0, canvas.width, canvas.height);
			balls.forEach(ball => {
				ctx.beginPath();
				ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2);
				ctx.fillStyle = ball.color;
				ctx.globalAlpha = ball.alpha;
				ctx.fill();
				ctx.globalAlpha = 1;
				ball.x += ball.vx;
				ball.y += ball.vy;
				// 边界反弹
				if (ball.x < ball.r || ball.x > canvas.width-ball.r) ball.vx *= -1;
				if (ball.y < ball.r || ball.y > canvas.height-ball.r) ball.vy *= -1;
			});
		}

		let silent = false;
		function removeBallsIfSilent() {
			if (Date.now() - lastSoundTime > delay) {
				if (!silent) {
					balls.forEach(ball => ball.fading = true);
					silent = true;
				}
			} else {
				silent = false;
			}
			// 逐渐减少 alpha 并移除
			for (let i = balls.length - 1; i >= 0; i--) {
				if (balls[i].fading) {
					balls[i].alpha -= 0.02;
					if (balls[i].alpha <= 0) {
						balls.splice(i, 1);
					}
				}
			}
		}

		function animate() {
			drawBalls();
			removeBallsIfSilent();
			// 分贝计算（volume为0时显示0），偏移100保证为正
			currentDb = currentVolume > 0 ? (20 * Math.log10(currentVolume) + 100).toFixed(1) : 0;
			volVal.textContent = currentDb;
			ballCount.textContent = balls.length;
			requestAnimationFrame(animate);
		}
		animate();

		// 授权按钮逻辑
		const micAuth = document.getElementById('micAuth');
		const authBtn = document.getElementById('authBtn');
		const settingBtn = document.getElementById('settingBtn');
		const settingModal = document.getElementById('settingModal');
		const micPermBtn = document.getElementById('micPermBtn');
		const closeSetting = document.getElementById('closeSetting');

	// 首次加载不弹出麦克风授权
		// 首次加载弹出“开始使用”弹窗
		micAuth.style.display = 'none';
		const modalTitle = document.getElementById('modalTitle');
		settingModal.style.display = 'flex';
		modalTitle.textContent = '开始使用';

		// 设置按钮弹出自定义设置弹窗
		settingBtn.onclick = function() {
			settingModal.style.display = 'flex';
			modalTitle.textContent = '设置';
		};
		closeSetting.onclick = function() {
			settingModal.style.display = 'none';
			modalTitle.textContent = '设置';
		};
		micPermBtn.onclick = function() {
			micAuth.style.display = 'flex';
			settingModal.style.display = 'none';
		};
		authBtn.onclick = function() {
			navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
				micAuth.style.display = 'none';
				// 获取设备列表
				updateMicList();
				// 默认用第一个设备
				startAudio();
			}).catch(err => {
				alert('无法访问麦克风: ' + err);
			});
		};
	</script>
</body>
</html>
